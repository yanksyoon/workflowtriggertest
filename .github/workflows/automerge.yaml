name: Auto Merge Oldest Pull Request

on:
    schedule:
        # Run at 9 AM and 9 PM UTC
        - cron: "0 9,21 * * *"
    workflow_dispatch:

jobs:
    auto-merge:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Merge oldest mergeable pull request
              run: |
                  echo "Looking for the oldest mergeable PR..."

                  # Get the oldest mergeable PR (sorted by creation date, ascending)
                  # --json number,createdAt --jq sorts by createdAt and gets the first number
                  PR_NUMBER=$(gh pr list --state open --json number,createdAt --jq 'sort_by(.createdAt) | .[] | select(.mergeable == "MERGEABLE") | .number' | head -n 1)

                  if [ -z "$PR_NUMBER" ]; then
                    echo "No mergeable PRs found."
                    exit 0
                  fi

                  echo "Found oldest mergeable PR #$PR_NUMBER"

                  # Final mergeability check right before merging
                  MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable --jq '.mergeable')
                  if [ "$MERGEABLE" = "MERGEABLE" ]; then
                    echo "Merging oldest PR #$PR_NUMBER..."
                    if gh pr merge "$PR_NUMBER" --merge --delete-branch; then
                      echo "✅ Successfully merged PR #$PR_NUMBER"
                    else
                      echo "❌ Failed to merge PR #$PR_NUMBER"
                      exit 1
                    fi
                  else
                    echo "PR #$PR_NUMBER is no longer mergeable (status: $MERGEABLE)"
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
