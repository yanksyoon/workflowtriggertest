name: Auto Merge Pull Requests

on:
    schedule:
        # Run at 9 AM and 9 PM UTC
        - cron: "0 9,21 * * *"
    workflow_dispatch:

jobs:
    auto-merge:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Get open pull requests
              id: get-prs
              run: |
                  # Get all open PRs that are mergeable
                  PRS=$(gh pr list --state open --json number --jq '.[] | select(.mergeable == "MERGEABLE") | .number')

                  if [ -z "$PRS" ]; then
                    echo "No mergeable pull requests found."
                    echo "mergeable_prs=" >> $GITHUB_OUTPUT
                  else
                    echo "Found mergeable PRs: $PRS"
                    # Convert newlines to commas for safe output handling
                    PR_LIST=$(echo "$PRS" | tr '\n' ',' | sed 's/,$//')
                    echo "mergeable_prs=$PR_LIST" >> $GITHUB_OUTPUT
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Merge pull requests
              if: steps.get-prs.outputs.mergeable_prs != ''
              run: |
                  echo "Merging pull requests..."
                  PR_LIST="${{ steps.get-prs.outputs.mergeable_prs }}"

                  # Convert comma-separated list back to array and iterate
                  IFS=',' read -ra PR_ARRAY <<< "$PR_LIST"
                  for pr_number in "${PR_ARRAY[@]}"; do
                    if [ -n "$pr_number" ]; then
                      echo "Merging PR #$pr_number"
                      gh pr merge "$pr_number" --merge --delete-branch
                    fi
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
